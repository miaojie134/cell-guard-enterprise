import{y as U,j as e,Z as Y,R as J,ad as ee,u as se,b as te,a4 as G,aw as N,a5 as L,C,d as I,f as q,e as O,g as R,B as _,af as K,a6 as F,aq as Q,r as re,a7 as k,ax as ae,ay as ne,P as ie,ac as S}from"./index-DoQD9WJV.js";import{v as V}from"./verificationService-CgJXCeex.js";import{a as Z,C as le}from"./clock-CMK8JJyI.js";const ce=[{value:"带班",label:"带班"},{value:"水军",label:"水军"},{value:"测试",label:"测试"},{value:"新媒体",label:"新媒体"},{value:"其他",label:"其他"}],$=({value:a,onValueChange:n,placeholder:r="请选择",className:l="h-9",options:o=ce})=>{const[i,m]=U.useState(!1),x=U.useRef(null);U.useEffect(()=>{const d=g=>{x.current&&!x.current.contains(g.target)&&m(!1)};return document.addEventListener("mousedown",d),()=>{document.removeEventListener("mousedown",d)}},[]);const f=o.find(d=>d.value===a);return e.jsxs("div",{ref:x,className:"relative",children:[e.jsxs("button",{type:"button",onClick:()=>m(!i),className:`${l} w-full px-3 py-2 text-sm border border-gray-300 rounded-md bg-white text-left flex items-center justify-between hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500`,children:[e.jsx("span",{className:f?"text-gray-900 font-normal":"text-gray-500 font-normal",children:f?f.label:r}),e.jsx(Y,{className:`h-3.5 w-3.5 text-gray-400 transition-transform ${i?"rotate-180":""}`})]}),i&&e.jsx("div",{className:"absolute top-full left-0 right-0 mt-1 bg-white border border-gray-300 rounded-md shadow-lg z-50 max-h-60 overflow-auto",children:o.map(d=>e.jsx("button",{type:"button",onClick:()=>{n(d.value),m(!1)},className:`w-full px-3 py-2 text-sm text-left hover:bg-gray-100 focus:outline-none focus:bg-gray-100 font-normal ${a===d.value?"bg-blue-50 text-blue-600":"text-gray-900"}`,children:d.label},d.value))})]})},W=a=>{let n;const r=new Set,l=(d,g)=>{const p=typeof d=="function"?d(n):d;if(!Object.is(p,n)){const y=n;n=g??(typeof p!="object"||p===null)?p:Object.assign({},n,p),r.forEach(j=>j(n,y))}},o=()=>n,x={setState:l,getState:o,getInitialState:()=>f,subscribe:d=>(r.add(d),()=>r.delete(d))},f=n=a(l,o,x);return x},oe=a=>a?W(a):W,me=a=>a;function de(a,n=me){const r=J.useSyncExternalStore(a.subscribe,()=>n(a.getState()),()=>n(a.getInitialState()));return J.useDebugValue(r),r}const X=a=>{const n=oe(a),r=l=>de(n,l);return Object.assign(r,n),r},ue=a=>a?X(a):X;function xe(a,n){let r;try{r=a()}catch{return}return{getItem:o=>{var i;const m=f=>f===null?null:JSON.parse(f,void 0),x=(i=r.getItem(o))!=null?i:null;return x instanceof Promise?x.then(m):m(x)},setItem:(o,i)=>r.setItem(o,JSON.stringify(i,void 0)),removeItem:o=>r.removeItem(o)}}const M=a=>n=>{try{const r=a(n);return r instanceof Promise?r:{then(l){return M(l)(r)},catch(l){return this}}}catch(r){return{then(l){return this},catch(l){return M(l)(r)}}}},he=(a,n)=>(r,l,o)=>{let i={storage:xe(()=>localStorage),partialize:t=>t,version:0,merge:(t,w)=>({...w,...t}),...n},m=!1;const x=new Set,f=new Set;let d=i.storage;if(!d)return a((...t)=>{console.warn(`[zustand persist middleware] Unable to update item '${i.name}', the given storage is currently unavailable.`),r(...t)},l,o);const g=()=>{const t=i.partialize({...l()});return d.setItem(i.name,{state:t,version:i.version})},p=o.setState;o.setState=(t,w)=>{p(t,w),g()};const y=a((...t)=>{r(...t),g()},l,o);o.getInitialState=()=>y;let j;const P=()=>{var t,w;if(!d)return;m=!1,x.forEach(h=>{var b;return h((b=l())!=null?b:y)});const v=((w=i.onRehydrateStorage)==null?void 0:w.call(i,(t=l())!=null?t:y))||void 0;return M(d.getItem.bind(d))(i.name).then(h=>{if(h)if(typeof h.version=="number"&&h.version!==i.version){if(i.migrate){const b=i.migrate(h.state,h.version);return b instanceof Promise?b.then(T=>[!0,T]):[!0,b]}console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}else return[!1,h.state];return[!1,void 0]}).then(h=>{var b;const[T,A]=h;if(j=i.merge(A,(b=l())!=null?b:y),r(j,!0),T)return g()}).then(()=>{v==null||v(j,void 0),j=l(),m=!0,f.forEach(h=>h(j))}).catch(h=>{v==null||v(void 0,h)})};return o.persist={setOptions:t=>{i={...i,...t},t.storage&&(d=t.storage)},clearStorage:()=>{d==null||d.removeItem(i.name)},getOptions:()=>i,rehydrate:()=>P(),hasHydrated:()=>m,onHydrate:t=>(x.add(t),()=>{x.delete(t)}),onFinishHydration:t=>(f.add(t),()=>{f.delete(t)})},i.skipHydration||P(),j||y},fe=he,Ne=a=>ue()(fe(n=>({verifiedNumbers:[],unlistedNumbers:[],setVerifiedNumbers:r=>n({verifiedNumbers:r}),setUnlistedNumbers:r=>n({unlistedNumbers:r}),updateVerifiedNumber:(r,l)=>n(o=>({verifiedNumbers:o.verifiedNumbers.map((i,m)=>m===r?{...i,...l}:i)})),updateUnlistedNumber:(r,l)=>n(o=>({unlistedNumbers:o.unlistedNumbers.map((i,m)=>m===r?{...i,...l}:i)})),addUnlistedNumber:()=>n(r=>({unlistedNumbers:[...r.unlistedNumbers,{phoneNumber:"",purpose:"",userComment:""}]})),removeUnlistedNumber:r=>n(l=>({unlistedNumbers:l.unlistedNumbers.filter((o,i)=>i!==r)})),clearAll:()=>n({verifiedNumbers:[],unlistedNumbers:[]})}),{name:`verification-${a}`,storage:{getItem:n=>{const r=sessionStorage.getItem(n);return r?JSON.parse(r):null},setItem:(n,r)=>{sessionStorage.setItem(n,JSON.stringify(r))},removeItem:n=>{sessionStorage.removeItem(n)}}})),pe=()=>{const{token:a}=ee();se();const[n,r]=U.useState(!1),l=[{value:"封号/停机",label:"封号/停机"},{value:"丢失/遗失",label:"丢失/遗失"},{value:"号码已注销",label:"号码已注销"},{value:"其他",label:"其他"}],o=U.useMemo(()=>a?Ne(a):null,[a]),i=o==null?void 0:o(),{verifiedNumbers:m,unlistedNumbers:x,setVerifiedNumbers:f,setUnlistedNumbers:d,updateVerifiedNumber:g,updateUnlistedNumber:p,addUnlistedNumber:y,removeUnlistedNumber:j,clearAll:P}=i||{verifiedNumbers:[],unlistedNumbers:[],setVerifiedNumbers:()=>{},setUnlistedNumbers:()=>{},updateVerifiedNumber:()=>{},updateUnlistedNumber:()=>{},addUnlistedNumber:()=>{},removeUnlistedNumber:()=>{},clearAll:()=>{}},{data:t,isLoading:w,error:v}=te({queryKey:["verification","employee",a],queryFn:()=>{if(!a)throw new Error("缺少验证令牌");return V.getEmployeeInfo(a)},enabled:!!a,retry:!1}),h=G({mutationFn:s=>{if(!a)throw new Error("缺少验证令牌");return V.submitVerification(a,s)},onSuccess:()=>{r(!0),P(),S({title:"提交成功",description:"您的反馈已成功提交，感谢您的配合！"})},onError:s=>{S({title:"提交失败",description:s instanceof Error?s.message:"提交失败，请稍后重试",variant:"destructive"})}}),b=G({mutationFn:s=>{if(!s)throw new Error("缺少验证令牌");return V.reactivateVerification(s)},onSuccess:s=>{s&&s.new_token&&(S({title:"重新激活成功",description:"已为您生成新的确认链接，3秒后将自动跳转..."}),setTimeout(()=>{window.location.href=`/verification/verify/${s.new_token}`},3e3))},onError:s=>{S({title:"重新激活失败",description:s instanceof Error?s.message:"无法重新激活，请联系管理员",variant:"destructive"})}});U.useEffect(()=>{if(t!=null&&t.phoneNumbers&&Array.isArray(t.phoneNumbers)&&m.length===0){const s=t.phoneNumbers.map(c=>({mobileNumberId:c.id,action:N.NOT_SELECTED,purpose:c.purpose||"",userComment:c.userComment||""}));f(s)}},[t,m.length,f]);const T=()=>{for(const s of m){if(s.action===N.NOT_SELECTED)return S({title:"表单验证失败",description:"请为所有号码选择使用状态（确认使用或报告问题）",variant:"destructive"}),!1;if(s.action===N.CONFIRM_USAGE){if(!s.purpose.trim())return S({title:"表单验证失败",description:"请填写确认使用号码的用途说明",variant:"destructive"}),!1}else if(s.action===N.REPORT_ISSUE&&!s.userComment)return S({title:"表单验证失败",description:"请选择问题类型",variant:"destructive"}),!1}for(const s of x){if(!s.phoneNumber.trim()||!s.purpose.trim())return S({title:"表单验证失败",description:"请完整填写新增号码的信息",variant:"destructive"}),!1;if(!/^1[3-9]\d{9}$/.test(s.phoneNumber))return S({title:"表单验证失败",description:"请输入正确的手机号码格式",variant:"destructive"}),!1}return!0},A=()=>{if(!T())return;const c={verifiedNumbers:m.filter(u=>u.action!==N.NOT_SELECTED),unlistedNumbersReported:x};h.mutate(c)};if(w)return e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:e.jsxs("div",{className:"text-center",children:[e.jsx(L,{className:"h-8 w-8 animate-spin mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"正在加载确认信息..."})]})});if(v||!t){const s=v==null?void 0:v.status,c=s===403;let u="访问失败",E="无法获取确认信息，请稍后重试或联系管理员。";return s===403?(u="链接已失效",E="此确认链接可能已被使用或已过期。如果您需要修改已提交的信息，可以申请一个新的链接。"):s===404?(u="链接无效",E="我们无法找到此确认链接。请您仔细核对链接地址是否正确，或联系管理员获取帮助。"):v instanceof Error&&(E=v.message),e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50 p-4",children:e.jsxs(C,{className:"w-full max-w-md text-center",children:[e.jsxs(I,{children:[e.jsx("div",{className:"mx-auto bg-red-100 rounded-full h-14 w-14 flex items-center justify-center",children:e.jsx(q,{className:"h-8 w-8 text-red-600"})}),e.jsx(O,{className:"mt-5 text-xl font-bold",children:u})]}),e.jsxs(R,{children:[e.jsx("p",{className:"text-gray-600 mb-6",children:E}),c&&a&&e.jsxs(_,{onClick:()=>b.mutate(a),disabled:b.isPending,className:"w-full",children:[b.isPending?e.jsx(L,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(K,{className:"h-4 w-4 mr-2"}),"重新获取确认链接"]})]})]})})}return n?e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50 p-4",children:e.jsxs(C,{className:"w-full max-w-md text-center",children:[e.jsxs(I,{children:[e.jsx("div",{className:"mx-auto bg-green-100 rounded-full h-14 w-14 flex items-center justify-center",children:e.jsx(Z,{className:"h-8 w-8 text-green-600"})}),e.jsx(O,{className:"mt-5 text-xl font-bold",children:"提交成功"})]}),e.jsx(R,{children:e.jsx("p",{className:"text-gray-600",children:"您的反馈已成功提交，感谢您的配合！"})})]})}):e.jsx("div",{className:"min-h-screen bg-gray-50 py-6",children:e.jsxs("div",{className:"container mx-auto px-4 max-w-4xl",children:[e.jsxs(C,{className:"mb-6",children:[e.jsxs(I,{className:"pb-4",children:[e.jsxs(O,{className:"flex items-center text-lg font-medium text-gray-900",children:[e.jsx(K,{className:"h-4 w-4 mr-2"}),"手机号码使用确认"]}),e.jsx(F,{className:"text-sm text-gray-600 mt-1",children:"请确认您当前使用的手机号码信息，如有问题请及时反馈"})]}),e.jsx(R,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{className:"text-gray-700",children:[e.jsx("span",{className:"font-medium text-gray-900",children:"姓名："}),e.jsx("span",{className:"ml-1",children:t.employeeName})]}),e.jsxs("div",{className:"flex items-center text-gray-700",children:[e.jsx(le,{className:"h-3.5 w-3.5 mr-1 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-900",children:"截止时间："}),e.jsxs("span",{className:"ml-1",children:[new Date(t.expiresAt).toLocaleDateString("zh-CN")," 23:59",e.jsx("span",{className:"text-xs text-gray-500 ml-1",children:"（超时未确认的号码可能会停机）"})]})]})]})})]}),e.jsxs(C,{className:"mb-6",children:[e.jsxs(I,{className:"pb-4",children:[e.jsx(O,{className:"text-lg font-medium text-gray-900",children:"请确认以下号码的使用情况"}),e.jsx(F,{className:"text-sm text-gray-600 mt-1",children:"请逐一确认每个号码的使用状态，并填写相关信息"}),(()=>{const s=m.length,c=m.filter(u=>u.action!==N.NOT_SELECTED).length;return s>0&&c<s?e.jsxs("div",{className:"mt-2 text-xs text-gray-600",children:["已确认 ",c,"/",s," 个号码"]}):null})()]}),e.jsx(R,{className:"space-y-4",children:((t==null?void 0:t.phoneNumbers)||[]).map((s,c)=>{var H,z,B;const u=(H=m[c])==null?void 0:H.action,E=u===N.NOT_SELECTED;return e.jsxs("div",{className:`border rounded-lg p-4 ${E?"border-orange-200 bg-orange-50/20":"border-gray-200 bg-gray-50/30"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-8 h-8 bg-blue-50 rounded-full flex items-center justify-center",children:e.jsx(Q,{className:"h-3.5 w-3.5 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900 text-sm",children:s.phoneNumber}),s.department&&e.jsx(re,{variant:"secondary",className:"text-xs mt-0.5 font-normal",children:s.department})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[E&&e.jsx("span",{className:"text-xs text-orange-600 font-medium",children:"待确认"}),e.jsxs("div",{className:"text-xs text-gray-500 bg-white px-2 py-1 rounded font-normal",children:[c+1,"/",((t==null?void 0:t.phoneNumbers)||[]).length]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4 items-end",children:[e.jsxs("div",{children:[e.jsxs(k,{className:"text-xs font-medium text-gray-700 mb-2 block",children:["使用状态 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs(_,{variant:u===N.CONFIRM_USAGE?"default":"outline",size:"sm",onClick:()=>g(c,{action:N.CONFIRM_USAGE,userComment:""}),className:`h-9 text-xs font-medium ${u===N.CONFIRM_USAGE?"bg-green-600 hover:bg-green-700 text-white":""}`,children:[e.jsx(Z,{className:"h-3 w-3 mr-1.5"}),"确认使用"]}),e.jsxs(_,{variant:u===N.REPORT_ISSUE?"destructive":"outline",size:"sm",onClick:()=>g(c,{action:N.REPORT_ISSUE,purpose:""}),className:"h-9 text-xs font-medium",children:[e.jsx(q,{className:"h-3 w-3 mr-1.5"}),"报告问题"]})]})]}),e.jsx("div",{className:"lg:col-span-2",children:u===N.NOT_SELECTED?e.jsx("div",{className:"h-9 flex items-center text-xs text-orange-600 italic",children:"← 请先选择使用状态"}):u===N.REPORT_ISSUE?e.jsxs(e.Fragment,{children:[e.jsxs(k,{className:"text-xs font-medium text-red-700 mb-2 block",children:["问题说明 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx($,{value:((z=m[c])==null?void 0:z.userComment)||"",onValueChange:D=>g(c,{userComment:D}),options:l})]}):e.jsxs(e.Fragment,{children:[e.jsxs(k,{className:"text-xs font-medium text-gray-700 mb-2 block",children:["用途说明 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx($,{value:((B=m[c])==null?void 0:B.purpose)||"",onValueChange:D=>g(c,{purpose:D})})]})})]})]},s.id)})})]}),((t==null?void 0:t.previouslyReportedUnlisted)||[]).length>0&&e.jsxs(C,{className:"mb-6",children:[e.jsx(I,{className:"pb-3",children:e.jsx(O,{className:"text-lg font-medium text-gray-900",children:"您之前上报的未列出号码"})}),e.jsx(R,{children:e.jsx("div",{className:"space-y-2",children:((t==null?void 0:t.previouslyReportedUnlisted)||[]).map((s,c)=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Q,{className:"h-3.5 w-3.5 text-gray-500"}),e.jsx("span",{className:"font-medium text-sm text-gray-900",children:s.phoneNumber}),e.jsxs("span",{className:"text-sm text-gray-600",children:["- ",s.purpose]})]}),e.jsx("span",{className:"text-xs text-gray-500 font-normal",children:s.reportedAt?new Date(s.reportedAt).toLocaleDateString("zh-CN"):""})]},c))})})]}),e.jsxs(C,{className:"mb-6",children:[e.jsxs(I,{className:"pb-4",children:[e.jsx(O,{className:"text-lg font-medium text-gray-900",children:"上报未列出的号码"}),e.jsx(F,{className:"text-sm text-gray-600 mt-1",children:"如果您正在使用的号码未在上述列表中，请在此添加"})]}),e.jsx(R,{children:e.jsxs("div",{className:"space-y-4",children:[x.map((s,c)=>e.jsx("div",{className:"border border-gray-100 rounded-lg p-4 bg-gray-50/20",children:e.jsxs("div",{className:"flex gap-3 items-start",children:[e.jsxs("div",{className:"flex-1 grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs(k,{className:"text-xs font-medium text-gray-700 mb-2 block",children:["手机号码 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(ae,{value:s.phoneNumber,onChange:u=>p(c,{phoneNumber:u.target.value}),placeholder:"请输入11位手机号",className:"h-9 text-sm"})]}),e.jsxs("div",{children:[e.jsxs(k,{className:"text-xs font-medium text-gray-700 mb-2 block",children:["用途说明 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx($,{value:s.purpose,onValueChange:u=>p(c,{purpose:u})})]})]}),e.jsx("div",{className:"pt-7",children:e.jsx(_,{variant:"outline",size:"sm",onClick:()=>j(c),className:"h-9 px-3",children:e.jsx(ne,{className:"h-3.5 w-3.5"})})})]})},c)),e.jsxs(_,{variant:"outline",onClick:y,className:"w-full h-10 mt-5 text-sm font-medium",children:[e.jsx(ie,{className:"h-3.5 w-3.5 mr-2"}),"添加号码"]})]})})]}),e.jsx("div",{className:"flex flex-col items-center space-y-3",children:(()=>{const s=m.filter(u=>u.action===N.NOT_SELECTED).length,c=h.isPending||s>0;return e.jsxs(e.Fragment,{children:[s>0&&e.jsxs("div",{className:"text-sm text-orange-600",children:["还有 ",s," 个号码待确认"]}),e.jsxs(_,{onClick:A,disabled:c,size:"lg",className:`px-8 text-sm font-medium ${c?"opacity-60":""}`,children:[h.isPending&&e.jsx(L,{className:"h-4 w-4 mr-2 animate-spin"}),"提交确认结果"]})]})})()})]})})};export{pe as default};
